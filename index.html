<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<html>
<head>
  <title>How a quadtree works</title>
  <link rel="stylesheet" type="text/css" href="quadtreevis.css" />
</head>

<body>

<p class="explanation">
  <h2>Here is a map of points in a space.</h2>
</p>

<svg id="widemap" class="quadtreemap" width="100%" height="75%">
  <g class="quadroot"></g>
  <g class="pointroot"></g>
</svg>

<p class="explanation">
  The space is divided into four <em>rectangles</em>. Each of those rectangles is divided such that it contains a maximum of <em>four children</em>. Each child is either a <em>point</em> or a smaller rectangle.
</p>
<p class="instructions">
  Click a rectangle and count its children to verify. None of them will contain more than four points or direct subrectangles.
</p>

<br />

<p class="explanation">
  Here is a graph of a <strong>quadtree</strong> representing the rectangles and points above.
</p>

<svg id="widetree" class="quadtreetree" width="100%" height="55%">
  <g class="treeroot"></g>
</svg>

<p class="post-svg-spacer-hack">&nbsp;</p>

<dl id="zoom-instructions" class="instructions">
  <dt>
    1. Zoom out to see more of the tree.
  </dt>
  <dd>
    <p>Roll the mouse wheel inside of the tree view.</p>
    <p>If you are on a touchscreen device, pinch out.</p>
  </dd>
  <dt>
    2. Pan around the tree.
  </dt>
  <dd>
    <p>Drag within the tree view.</p>
  </dd>
  <dt class="dismiss-link-container">
    <button id="dismiss-zoom-instructions" data-target="zoom-instructions">Got it.</button>
  </dt>
</dl>

<div class="explanation">
  <h3>What am I looking at here?</h3>
  <ul>
    <li>
      Each <span class="green reverse-highlight">green node</span> represents a <em>rectangle</em> in a space.
    </li>
    <li>
      Each <span class="white reverse-highlight">white node</span> represents a <em>point</em> in that same space.
    </li>
    <li>
      The green nodes can have up to <em>four children</em>, either white or green. These children are contained within the rectangle that the green node represents.
    </li>
    <li>
      (Gray nodes represent vacancies, spots for children that are not yet occupied.)
    </li>
  </ul>
</div>

</div>


<div class="two-bars">
  <div class="mainbar explanation">
    <h3>Why four children?</h3>
    <p>
      By <a href="http://en.wikipedia.org/wiki/Quadtree">definition</a>, a quadtree is a tree in which each node has at most four children. Quadtree implementations &mdash; like <a href="https://github.com/mbostock/d3/wiki/Quadtree-Geom">D3's</a> (<a href="https://github.com/mbostock/d3/blob/master/src/geom/quadtree.js">source</a>) &mdash; ensure that as points are added to the tree, nodes are rearranged such that none of them have more than four children.
    </p>

    <p>
      Below are the graph of the quadtree and the map of the points and rectangles it represents again, <strong>side-by-side</strong> so that you can see how they relate to each other.
    </p>    
  </div>
  <div class="sidebar">
    <p>
      When a new point is inserted into a <a href="https://github.com/mbostock/d3/blob/master/src/geom/quadtree.js#L101">D3 quadtree</a>:
      <ol>
        <li>It decides which quadrant</a> of the root node that the point should be in ( by checking the point's x and y against the horiontal center and vertical centers of the node's quad).
        </li>
        <li>
          If there is a leaf node (let's call it N) in that quadrant, <a href="https://github.com/mbostock/d3/blob/master/src/geom/quadtree.js#L84">it moves N's point into a child of N</a> and adds the new point as a child of N as well.
        </li>
        <li>N is <a href="https://github.com/mbostock/d3/blob/master/src/geom/quadtree.js#L108">marked as a non-leaf</a> because it has children.
        </li>
      </ol>
    </p>
  </div>
</div>

  <dl id="sidebyside-instructions" class="instructions">
    <dt>
      1. Look at how the map correlates to the tree.
    </dt>
    <dd>
      <p>
        Click on an rectangle or point in the map view (below on the left). The tree view (below on the right) will pan to the corresponding node in the tree.
      </p>
      <p>
        Zoom out and pan around the tree view to see the node in context.
      </p>
    </dd>
    <dt>
      2. Look at how the tree correlates to the map.
    </dt>
    <dd>
      <p>
        Click on a tree node in the tree view. The map will highlight the area or point that it represents.
      </p>
    </dd>
    <dt class="dismiss-link-container">
      <button id="dismiss-sidebyside-instructions" data-target="sidebyside-instructions">Yope. I see how that goes.</button>
    </dt>
  </dl>


<p class="post-svg-spacer-hack">&nbsp;</p>

<svg id="sidebysidetree" class="quadtreetree" width="49%" height="70%">
  <g class="treeroot"></g>
</svg>

<svg id="sidebysidemap" class="quadtreemap" width="49%" height="70%">
  <g class="quadroot"></g>
  <g class="pointroot"></g>
</svg>

<pre id="node-json-box" class="details-box">
</pre>

<div id="add-points-instructions" class="instructions">
  <ul>
    <li>
      For fun, <button id="add-points-button">Add one hundred points</button> and see how the map and tree rearrange themselves.
    </li>
    <li>
      <strong>If</strong> you are interested in D3's implementation of the quadtree, click on a node, rectangle, or point, then <button id="show-node-json" data-target="node-json-box">Show the quadtree node contents</button>.
    </li>
  </ul>
  <!-- <button id="delete-point-button">Delete selected point</button> -->
</div>


<p>In the D3 quadtree, each node is either a leaf or a non-leaf.</p>
<ul>
  <li>Each leaf stores information describing a point: x and y values.</li>
  <li>Each non-leaf represents a quadrant, a sub-rectangle within the space, and has children, which are either leaves (points) or other non-leaves (quadrants).</li>
</ul>

<p class="aside">
  A quadtree used to divide up a 2D space is analogous to a <a href="http://en.wikipedia.org/wiki/Binary_tree">binary tree</a> dividing a 1D space (a line). If you have random points on a line, you can arrange points in a binary tree in such a way that the two children of the root node each represent halves of the line, and the grandchildren each represent quarters of the line, and so forth. So, when you search for a given point on the line, rather than examining every point on the line, you can simply walk down the tree.
</p>

<p>
I put this together to better understand how a quadtree rearranges itself to accommodate points that are added to it. <a href="https://github.com/jimkang/quadtreevis">The source is here.</a>


<script src="lib/d3.js"></script>
<script src="node_modules/quadtreenodereport/quadtreenodereport.js"></script>
<script src="node_modules/quadtreelabeler/quadtreelabeler.js"></script>

<script src="node_modules/quadtreetree/node_modules/lodash/dist/lodash.min.js"></script>
<script src="node_modules/quadtreetree/node_modules/one-at/one-at.js"></script>

<script src="node_modules/quadtreetree/accessors.js"></script>
<script src="node_modules/quadtreetree/idmaker.js"></script>
<script src="node_modules/quadtreetree/quadtree-to-layout-tree.js"></script>
<script src="node_modules/quadtreetree/quadtreetree.js"></script>

<script src="node_modules/quadtreemap/renderquadtreepoints.js"></script>
<script src="node_modules/quadtreemap/mapquadrenderer.js"></script>
<script src="node_modules/quadtreemap/quadtreemap.js"></script>

<script src="node_modules/svgcamera/camera.js"></script>

<script type="text/javascript" src="example-quadtree.js"></script>
<script type="text/javascript" src="exhibit-helpers.js"></script>
<script type="text/javascript" src="exhibit-reporter.js"></script>
<script type="text/javascript" src="exhibit-controller.js"></script>

<script type="text/javascript">
// var exercise = createQuadtreeExercise();
// console.log(quadtree.nodes);

</script>

</body>
</html>

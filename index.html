<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<html>
<head>
  <title>How a quadtree works</title>
  <link rel="stylesheet" type="text/css" href="quadtreevis.css" />
</head>

<body>

<p class="explanation">
  Here is a graph of a <strong>quadtree</strong>.
</p>

<svg id="widetree" class="quadtreetree" width="100%" height="55%">
  <g class="treeroot"></g>
</svg>

<p class="post-svg-spacer-hack">&nbsp;</p>

<div class="two-bars">
  <dl id="zoom-instructions" class="instructions sidebar">
    <dt>
      1. Zoom out to see more of the tree.
    </dt>
    <dd>
      <p>Roll the mouse wheel inside of the tree view.</p>
      <p>(If you are on a touchscreen device, pinch out.</p>
    </dd>
    <dt>
      2. Pan around.
    </dt>
    <dd>
      Drag within the tree view.
    </dd>
    <dt class="dismiss-link-container">
      <a id="dismiss-zoom-instructions" href="#hide_zoom-instructions">Got it.</a>
    </dt>
  </dl>

  <div class="explanation mainbar">
    <h3>What am I looking at here?</h3>
    <ul>
      <li>
        Each <span class="orange reverse-highlight">orange node</span> represents a <em>rectangle</em> in a space.
      </li>
      <li>
        Each <span class="red reverse-highlight">red node</span> represents a point within a rectangle.
      </li>
      <li>
        The orange nodes can have up to <em>four children</em>.
      </li>
      <li>
        A child of an orange node can be another orange node. That represents a smaller rectangle within a larger rectangle.
      </li>
      <li>
        A child can be a red node.
      </li>
    </ul>
  </div>
</div>

<p class="explanation">
  Here are those represented rectangles and points mapped out "physically," so to speak:
</p>

<svg id="widemap" class="quadtreemap" width="100%" height="75%">
  <g class="quadroot"></g>
  <g class="pointroot"></g>
</svg>

<p class="explanation">
  In the same way that the graph showed that each orange node had up to four children, in this map, you can see that each rectangle contains within it up to four subrectangles or points.
</p>

<div class="explanation">
  <p>
    This is not a coincidence. By <a href="http://en.wikipedia.org/wiki/Quadtree">definition</a>, a quadtree is a tree in which each node has at most four children. Quadtree implementations (like <a href="https://github.com/mbostock/d3/wiki/Quadtree-Geom">D3's</a> &mdash; <a href="https://github.com/mbostock/d3/blob/master/src/geom/quadtree.js">source</a>) ensure that as points are added to the tree, nodes are rearranged such that none of them have more than four children.
  </p>
  <p>
    When a new point is inserted into a <a href="https://github.com/mbostock/d3/blob/master/src/geom/quadtree.js#L101">D3 quadtree</a>:
    <ol>
      <li>It decides which quadrant</a> of the root node that the point should be in ( by checking the point's x and y against the horiontal center and vertical centers of the node's quad).
      </li>
      <li>
        If there is a leaf node (let's call it N) in that quadrant, <a href="https://github.com/mbostock/d3/blob/master/src/geom/quadtree.js#L84">it moves N's point into a child of N</a> and adds the new point as a child of N as well.
      </li>
      <li>N is <a href="https://github.com/mbostock/d3/blob/master/src/geom/quadtree.js#L108">marked as a non-leaf</a> because it has children.
      </li>
    </ol>
  </p>
</div>

<p class="explanation">
  Here are the graph of the quadtree and the map of the points and rectangles it represents again, side-by-side so that you can see how they relate to each other.
</p>
<p class="instructions">
  Click on an area or point in the map to show the corresponding tree node in the graph. Click on a tree node in the graph to highlight the area or point that it covers in the map.
</p>

<svg id="sidebysidetree" class="quadtreetree" width="49%" height="70%">
  <g class="treeroot"></g>
</svg>

<svg id="sidebysidemap" class="quadtreemap" width="49%" height="70%">
  <g class="quadroot"></g>
  <g class="pointroot"></g>
</svg>


<pre class="details-box">
</pre>


<p class="instructions">The map in the left pane depicts the areas represented by the quadtree nodes. The graph in the right pane shows the quadtree as a tree. </p>


<div>
  <button id="add-points-button">Add a hundred points</button>
  <!-- <button id="delete-point-button">Delete selected point</button> -->
</div>

<p class="aside">
  A quadtree used to divide up a 2D space is analogous to a <a href="http://en.wikipedia.org/wiki/Binary_tree">binary tree</a> dividing a 1D space (a line). If you have random points on a line, you can arrange points in a binary tree in such a way that the two children of the root node each represent halves of the line, and the grandchildren each represent quarters of the line, and so forth. So, when you search for a given point on the line, rather than examining every point on the line, you can simply walk down the tree.
</p>
<p>In the D3 quadtree, each node is either a leaf or a non-leaf.</p>
<ul>
  <li>Each leaf stores information describing a point: x and y values.</li>
  <li>Each non-leaf represents a quadrant, a sub-rectangle within the space, and has children, which are either leaves (points) or other non-leaves (quadrants).</li>
</ul>

<p>
I put this together to better understand how a quadtree rearranges itself to accommodate points that are added to it. <a href="https://github.com/jimkang/quadtreevis">The source is here.</a>


<script src="lib/d3.js"></script>
<script src="node_modules/quadtreenodereport/quadtreenodereport.js"></script>
<script src="node_modules/quadtreelabeler/quadtreelabeler.js"></script>

<script src="node_modules/quadtreetree/node_modules/lodash/dist/lodash.min.js"></script>
<script src="node_modules/quadtreetree/node_modules/one-at/one-at.js"></script>

<script src="node_modules/quadtreetree/accessors.js"></script>
<script src="node_modules/quadtreetree/idmaker.js"></script>
<script src="node_modules/quadtreetree/quadtree-to-layout-tree.js"></script>
<script src="node_modules/quadtreetree/quadtreetree.js"></script>

<script src="node_modules/quadtreemap/renderquadtreepoints.js"></script>
<script src="node_modules/quadtreemap/mapquadrenderer.js"></script>
<script src="node_modules/quadtreemap/quadtreemap.js"></script>

<script src="node_modules/svgcamera/camera.js"></script>

<script type="text/javascript" src="example-quadtree.js"></script>
<script type="text/javascript" src="exhibit-helpers.js"></script>
<script type="text/javascript" src="exhibit-reporter.js"></script>
<script type="text/javascript" src="exhibit-controller.js"></script>

<script type="text/javascript">
// var exercise = createQuadtreeExercise();
// console.log(quadtree.nodes);

</script>

</body>
</html>
